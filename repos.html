<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Â≠∏Áîü‰ΩúÂìÅÈõÜ</title>
    <style>
      :root {
        --bg-color: #0d1117;
        --card-bg: #161b22;
        --text-main: #c9d1d9;
        --text-secondary: #8b949e;
        --accent: #58a6ff;
        --border: #30363d;
        --success: #238636;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }

      h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      .back-btn {
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }

      .back-btn:hover {
        background-color: #79c0ff;
      }

      .repos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 15px;
      }

      .repo-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 15px;
        transition: transform 0.2s, border-color 0.2s;
        display: flex;
        flex-direction: column;
        cursor: pointer;
      }

      .repo-card:hover {
        border-color: var(--accent);
        transform: translateY(-2px);
      }

      .repo-title {
        text-decoration: none;
        color: inherit;
      }

      .repo-title:hover {
        text-decoration: underline;
      }

      .repo-name {
        font-weight: bold;
        color: var(--accent);
        font-size: 1.1rem;
        margin-bottom: 8px;
      }

      .repo-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 12px;
      }

      .repo-iframe {
        width: 100%;
        height: 250px;
        border: 1px solid var(--border);
        border-radius: 4px;
        background-color: var(--bg-color);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .error {
        background-color: #da3633;
        color: white;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .empty {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      /* Like Button Styles */
      .like-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        margin-top: 10px;
      }

      .like-btn:hover {
        border-color: var(--text-main);
        color: var(--text-main);
        transform: scale(1.05);
      }

      .like-btn.liked {
        border-color: #da3633;
        color: #da3633;
        background-color: rgba(218, 54, 51, 0.1);
      }

      .like-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .like-btn .heart {
        font-size: 1.1rem;
        transition: transform 0.2s;
      }

      .like-btn.liked .heart {
        animation: heartBeat 0.3s ease;
      }

      @keyframes heartBeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
      }

      .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--border);
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1 id="pageTitle">Â≠∏Áîü‰ΩúÂìÅÈõÜ</h1>
        <button class="back-btn" onclick="goBack()">‚Üê ËøîÂõû</button>
      </header>

      <div id="errorMsg" class="error" style="display: none;"></div>

      <div id="loading" class="loading">ËºâÂÖ•‰∏≠...</div>

      <div id="reposGrid" class="repos-grid" style="display: none;"></div>

      <div id="empty" class="empty" style="display: none;">
        Ê≠§Â≠∏ÁîüÊ≤íÊúâ‰ΩúÂìÅ
      </div>
    </div>

    <script>
      // Supabase Configuration
      const SUPABASE_URL = 'https://wnvgjuhxxwnihmjfrcvk.supabase.co'; // Replace with your Supabase URL
      const SUPABASE_ANON_KEY = 'sb_publishable_MR0Q28M6SwAHDyy5iqdQXA_U26L7s6b'; // Replace with your Supabase anon key
      
      // Initialize Supabase client
      let supabaseClient = null;
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } catch (err) {
        console.warn('Supabase not configured:', err);
      }

      const params = new URLSearchParams(window.location.search);
      const username = params.get('user');

      // Local Storage Manager for tracking liked repos
      class LikeStorage {
        static getKey(username, repoName) {
          return `liked_${username}_${repoName}`;
        }

        static isLiked(username, repoName) {
          return localStorage.getItem(this.getKey(username, repoName)) === 'true';
        }

        static setLiked(username, repoName, liked) {
          if (liked) {
            localStorage.setItem(this.getKey(username, repoName), 'true');
          } else {
            localStorage.removeItem(this.getKey(username, repoName));
          }
        }
      }

      // Like Service for supabaseClient operations
      class LikeService {
        static async fetchLikes(username) {
          if (!supabaseClient) return {};
          
          try {
            const { data, error } = await supabaseClient
              .from('gh_portfolio_likes')
              .select('repo_name, like_count')
              .eq('username', username);

            if (error) throw error;

            const likesMap = {};
            data.forEach(item => {
              likesMap[item.repo_name] = item.like_count;
            });
            return likesMap;
          } catch (err) {
            console.error('Error fetching likes:', err);
            return {};
          }
        }

        static async incrementLike(username, repoName) {
          if (!supabaseClient) return false;

          try {
            // Try to insert or update
            const { data, error } = await supabaseClient
              .from('gh_portfolio_likes')
              .upsert(
                { 
                  username, 
                  repo_name: repoName, 
                  like_count: 1 
                },
                { 
                  onConflict: 'username,repo_name',
                  ignoreDuplicates: false 
                }
              )
              .select();

            if (error) {
              // If record exists, increment it
              const { data: updateData, error: updateError } = await supabaseClient.rpc(
                'increment_like',
                { p_username: username, p_repo_name: repoName }
              );
              
              if (updateError) {
                // Fallback: fetch current count and update
                const { data: current } = await supabaseClient
                  .from('gh_portfolio_likes')
                  .select('like_count')
                  .eq('username', username)
                  .eq('repo_name', repoName)
                  .single();

                if (current) {
                  await supabaseClient
                    .from('gh_portfolio_likes')
                    .update({ like_count: current.like_count + 1 })
                    .eq('username', username)
                    .eq('repo_name', repoName);
                }
              }
            }

            return true;
          } catch (err) {
            console.error('Error incrementing like:', err);
            return false;
          }
        }

        static async decrementLike(username, repoName) {
          if (!supabaseClient) return false;

          try {
            const { data: current } = await supabaseClient
              .from('gh_portfolio_likes')
              .select('like_count')
              .eq('username', username)
              .eq('repo_name', repoName)
              .single();

            if (current && current.like_count > 0) {
              const { error } = await supabaseClient
                .from('gh_portfolio_likes')
                .update({ like_count: current.like_count - 1 })
                .eq('username', username)
                .eq('repo_name', repoName);

              if (error) throw error;
            }

            return true;
          } catch (err) {
            console.error('Error decrementing like:', err);
            return false;
          }
        }
      }

      function goBack() {
        window.history.back();
      }

      // Render like button
      function renderLikeButton(username, repoName, likeCount, isLiked) {
        const btn = document.createElement('button');
        btn.className = `like-btn ${isLiked ? 'liked' : ''}`;
        btn.innerHTML = `
          <span class="heart">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
          <span class="count">${likeCount || 0}</span>
        `;
        btn.onclick = (e) => {
          e.stopPropagation();
          handleLikeClick(username, repoName, btn);
        };
        return btn;
      }

      // Handle like button click
      async function handleLikeClick(username, repoName, btn) {
        if (btn.disabled) return;

        btn.disabled = true;
        const isCurrentlyLiked = LikeStorage.isLiked(username, repoName);
        const countSpan = btn.querySelector('.count');
        const heartSpan = btn.querySelector('.heart');
        let currentCount = parseInt(countSpan.textContent) || 0;

        // Optimistic UI update
        if (isCurrentlyLiked) {
          // Unlike
          currentCount = Math.max(0, currentCount - 1);
          countSpan.textContent = currentCount;
          heartSpan.textContent = 'ü§ç';
          btn.classList.remove('liked');
          LikeStorage.setLiked(username, repoName, false);

          // Update database
          const success = await LikeService.decrementLike(username, repoName);
          if (!success) {
            // Revert on error
            currentCount++;
            countSpan.textContent = currentCount;
            heartSpan.textContent = '‚ù§Ô∏è';
            btn.classList.add('liked');
            LikeStorage.setLiked(username, repoName, true);
          }
        } else {
          // Like
          currentCount++;
          countSpan.textContent = currentCount;
          heartSpan.textContent = '‚ù§Ô∏è';
          btn.classList.add('liked');
          LikeStorage.setLiked(username, repoName, true);

          // Update database
          const success = await LikeService.incrementLike(username, repoName);
          if (!success) {
            // Revert on error
            currentCount = Math.max(0, currentCount - 1);
            countSpan.textContent = currentCount;
            heartSpan.textContent = 'ü§ç';
            btn.classList.remove('liked');
            LikeStorage.setLiked(username, repoName, false);
          }
        }

        btn.disabled = false;
      }

      async function loadPortfolioItems() {
        if (!username) {
          document.getElementById('errorMsg').innerText = 'Êú™ÊåáÂÆöÁî®Êà∂';
          document.getElementById('errorMsg').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
          return;
        }

        document.getElementById('pageTitle').innerText = `${username} ÁöÑ‰ΩúÂìÅÈõÜ`;

        try {
          // Fetch portfolio data from static JSON file
          const response = await fetch('/portfolio-data.json');
          const allData = await response.json();
          const items = allData[username] || [];

          if (!items || items.length === 0) {
            document.getElementById('empty').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            return;
          }

          // Fetch like counts from Supabase
          const likesMap = await LikeService.fetchLikes(username);

          // Display items
          const grid = document.getElementById('reposGrid');
          grid.innerHTML = '';

          items.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'repo-card';

            const likeCount = likesMap[item.name] || 0;
            const isLiked = LikeStorage.isLiked(username, item.name);

            // For directories, try to load index.html as iframe
            if (item.type === 'directory') {
              card.innerHTML = `
                <a href="${item.repoUrl}" target="_blank" class="repo-title" onclick="event.stopPropagation();">
                  <div class="repo-name">üìÅ ${item.name}</div>
                </a>
                <div class="repo-description">ÈªûÊìäÂç°ÁâáÂú®Êñ∞Ë¶ñÁ™óÈñãÂïü</div>
                <iframe src="portfolio/${username}/${item.name}/index.html" class="repo-iframe" title="${item.name}"></iframe>
              `;
              
              const footer = document.createElement('div');
              footer.className = 'card-footer';
              footer.appendChild(renderLikeButton(username, item.name, likeCount, isLiked));
              card.appendChild(footer);

              card.onclick = (e) => {
                if (!e.target.closest('.like-btn')) {
                  window.open(`portfolio/${username}/${item.name}/index.html`, '_blank');
                }
              };
            } else {
              card.innerHTML = `
                <a href="${item.repoUrl}" target="_blank" class="repo-title" onclick="event.stopPropagation();">
                  <div class="repo-name">üìÑ ${item.name}</div>
                </a>
                <div class="repo-description">Ê™îÊ°à</div>
              `;
              
              const footer = document.createElement('div');
              footer.className = 'card-footer';
              footer.appendChild(renderLikeButton(username, item.name, likeCount, isLiked));
              card.appendChild(footer);
            }

            grid.appendChild(card);
          });

          grid.style.display = 'grid';
          document.getElementById('loading').style.display = 'none';
        } catch (err) {
          console.error('Portfolio load error:', err);
          document.getElementById('errorMsg').innerText = `ÈåØË™§: ${err.message}`;
          document.getElementById('errorMsg').style.display = 'block';
          document.getElementById('loading').style.display = 'none';
        }
      }

      // Load on page load
      loadPortfolioItems();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>Supabase 即時聊天室</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 500px;
        margin: 20px auto;
      }
      #chat-box {
        height: 300px;
        border: 1px solid #ccc;
        overflow-y: scroll;
        padding: 10px;
        margin-bottom: 10px;
        background: #f9f9f9;
      }
      .msg {
        margin-bottom: 8px;
      }
      .msg b {
        color: #007bff;
      }
      input {
        padding: 8px;
        width: 70%;
      }
      button {
        padding: 8px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Supabase 聊天室</h2>

    <div id="chat-box"></div>

    <input
      type="text"
      id="username"
      placeholder="你的名字"
      style="width: 20%"
    />
    <input type="text" id="content" placeholder="輸入訊息..." />
    <button onclick="sendMessage()">送出</button>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // 1. 初始化 Supabase
      const SUPABASE_URL = 'https://qmogntgsuxjwolqrhoqh.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_yC_R-ypFm--0z-yhpevwRA_8jRXudiG';

      // 關鍵修正：將變數名改為 supabaseClient，避免與 window.supabase 衝突
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const chatBox = document.getElementById('chat-box');
      const contentInput = document.getElementById('content');
      const usernameInput = document.getElementById('username');

      // 2. 讀取舊訊息
      async function fetchMessages() {
        const { data, error } = await supabaseClient
          .from('messages')
          .select('*')
          .order('id', { ascending: true }); // 如果沒有 created_at，可以用 id 排序

        if (data) {
          chatBox.innerHTML = ''; // 清空重新渲染
          data.forEach(appendMessage);
        }
      }

      // 3. 將訊息渲染到畫面上
      function appendMessage(msg) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${msg.username || '匿名'}:</b> ${msg.content}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      // 4. 發送訊息到 Supabase
      async function sendMessage() {
        const content = contentInput.value.trim();
        const username = usernameInput.value.trim() || '匿名';

        if (!content) return;

        const { error } = await supabaseClient
          .from('messages')
          .insert([{ content, username }]);

        if (error) {
          alert('發送失敗：' + error.message);
        } else {
          contentInput.value = '';
        }
      }

      // 5. 監聽即時更新
      supabaseClient
        .channel('public:messages')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'messages' },
          (payload) => {
            appendMessage(payload.new);
          }
        )
        .subscribe();

      // 監聽 Enter 鍵發送（提升體驗）
      contentInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      // 執行載入
      fetchMessages();
    </script>
  </body>
</html>

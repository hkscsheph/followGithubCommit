<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç”Ÿ JS å³æ™‚èŠå¤©å®¤</title>
    <style>
        /* åŸºæœ¬æ’ç‰ˆ */
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #e5ddd5; }
        
        /* è¨Šæ¯é¡¯ç¤ºå€ */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* è¨Šæ¯æ°£æ³¡æ¨£å¼ */
        .msg { background: white; padding: 8px 12px; border-radius: 8px; max-width: 75%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; position: relative; }
        .msg.mine { align-self: flex-end; background: #dcf8c6; }
        .sender { font-size: 0.7rem; color: #888; font-weight: bold; margin-bottom: 4px; display: block; }
        .chat-img { max-width: 100%; border-radius: 6px; margin-top: 8px; display: block; cursor: pointer; }

        /* ä¸‹æ–¹è¼¸å…¥å€ */
        .input-area { background: #f0f0f0; padding: 12px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ccc; position: relative; z-index: 100; }
        
        /* ä¿®æ­£ input ç„¡æ³•è¼¸å…¥çš„å•é¡Œï¼šç¢ºä¿æ²’æœ‰è¢«é®æ“‹ä¸”å¯¬åº¦æ­£ç¢º */
        input[type="text"] { 
            flex: 1; 
            padding: 10px 15px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            outline: none; 
            font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
            background: white;
        }

        .icon-btn { cursor: pointer; font-size: 1.5rem; user-select: none; }
        #send-btn { background: #128c7e; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        #send-btn:disabled { background: #bbb; }

        /* ä¸Šå‚³ç‹€æ…‹ */
        #status-bar { font-size: 0.8rem; color: #555; padding: 2px 15px; background: #eee; display: none; }
    </style>
</head>
<body>

<div id="chat-window"></div>
<div id="status-bar">æ­£åœ¨è™•ç†...</div>

<div class="input-area">
    <input type="text" id="username" placeholder="æš±ç¨±" style="flex: 0 0 70px;">
    
    <label class="icon-btn" title="ä¸Šå‚³åœ–ç‰‡">
        ğŸ“·
        <input type="file" id="image-input" hidden accept="image/*">
    </label>
    
    <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
    
    <button id="send-btn">â¤</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // 1. åˆå§‹åŒ– Supabase (è«‹æ›¿æ›ç‚ºä½ çš„è³‡è¨Š)
    const SUPABASE_URL = 'https://dhypkutxhcfjpzmlufxr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_1k3-mNqoqErdRgxC0P11zA_fXVopcwJ';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const chatWindow = document.getElementById('chat-window');
    const msgInput = document.getElementById('msg-input');
    const userInput = document.getElementById('username');
    const imageInput = document.getElementById('image-input');
    const sendBtn = document.getElementById('send-btn');
    const statusBar = document.getElementById('status-bar');

    // 2. æ¸²æŸ“è¨Šæ¯å‡½å¼
    function renderMessage(msg) {
        const isMine = msg.sender === userInput.value && userInput.value !== '';
        const div = document.createElement('div');
        div.className = `msg ${isMine ? 'mine' : ''}`;
        
        let contentHtml = `<span class="sender">${msg.sender || 'åŒ¿å'}</span>`;
        if (msg.content) contentHtml += `<div>${msg.content}</div>`;
        if (msg.image_url) {
            contentHtml += `<a href="${msg.image_url}" target="_blank"><img src="${msg.image_url}" class="chat-img"></a>`;
        }
        
        div.innerHTML = contentHtml;
        chatWindow.appendChild(div);
        
        // æ»¾å‹•åˆ°åº•éƒ¨
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // 3. ç™¼é€è¨Šæ¯èˆ‡ä¸Šå‚³åœ–ç‰‡é‚è¼¯
    async function handleSend() {
        const sender = userInput.value.trim() || 'åŒ¿åè€…';
        const content = msgInput.value.trim();
        const imageFile = imageInput.files[0];

        if (!content && !imageFile) return;

        // é–å®š UI
        sendBtn.disabled = true;
        msgInput.disabled = true;
        let imageUrl = null;

        try {
            // A. è™•ç†åœ–ç‰‡ä¸Šå‚³
            if (imageFile) {
                statusBar.style.display = 'block';
                statusBar.innerText = 'æ­£åœ¨ä¸Šå‚³åœ–ç‰‡...';
                
                const fileExt = imageFile.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;
                
                const { data: uploadData, error: uploadError } = await _supabase.storage
                    .from('chat_images')
                    .upload(fileName, imageFile);

                if (uploadError) throw uploadError;

                // å–å¾—åœ–ç‰‡å…¬é–‹ç¶²å€
                const { data: { publicUrl } } = _supabase.storage
                    .from('chat_images')
                    .getPublicUrl(fileName);
                
                imageUrl = publicUrl;
            }

            // B. å¯«å…¥è³‡æ–™åº«
            const { error: dbError } = await _supabase
                .from('messages')
                .insert([{ sender, content, image_url: imageUrl }]);

            if (dbError) throw dbError;

            // C. æˆåŠŸå¾Œæ¸…ç©º
            msgInput.value = '';
            imageInput.value = '';
            statusBar.style.display = 'none';

        } catch (err) {
            console.error('Error:', err);
            alert('éŒ¯èª¤: ' + err.message);
        } finally {
            sendBtn.disabled = false;
            msgInput.disabled = false;
            msgInput.focus();
        }
    }

    // 4. åˆå§‹åŒ–ï¼šè¼‰å…¥æ­·å²èˆ‡ç›£è½å³æ™‚æ›´æ–°
    async function init() {
        // è¼‰å…¥æœ€è¿‘ 50 æ¢è¨Šæ¯
        const { data, error } = await _supabase
            .from('messages')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(50);
        
        if (data) data.forEach(renderMessage);

        // é–‹å•Ÿ Realtime ç›£è½
        _supabase
            .channel('public:messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                renderMessage(payload.new);
            })
            .subscribe();
    }

    // äº‹ä»¶ç›£è½
    sendBtn.onclick = handleSend;
    msgInput.onkeydown = (e) => {
        if (e.key === 'Enter') handleSend();
    };

    // å•Ÿå‹•
    init();
</script>
</body>
</html>
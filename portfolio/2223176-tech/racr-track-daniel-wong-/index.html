<!DOCTYPE html>
<html>
<head>
    <title>NBA Racer: Pro Circuit</title>
    <style>
        body { margin: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; color: white; font-family: 'Arial Black', sans-serif; overflow: hidden; }
        canvas { background: #1b5e20; border: 10px solid #444; border-radius: 5px; cursor: none; }
        .hud { display: flex; justify-content: space-around; width: 900px; padding: 10px; background: rgba(0,0,0,0.5); border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .p1 { color: #ff3d00; } .p2 { color: #ffea00; }
        #winOverlay { position: absolute; display: none; background: rgba(0,0,0,0.9); padding: 50px; text-align: center; border: 4px solid gold; z-index: 10; }
    </style>
</head>
<body>
    <div id="winOverlay">
        <h1 id="winnerText"></h1>
        <p>PRESS 'R' TO REMATCH</p>
    </div>
    <div class="hud">
        <div class="p1">P1 LAPS: <span id="p1Laps">0</span>/3</div>
        <div class="p2">P2 LAPS: <span id="p2Laps">0</span>/3</div>
    </div>
    <canvas id="raceCanvas"></canvas>

    <script>
        const canvas = document.getElementById('raceCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 900;
        canvas.height = 600;

        let gameOver = false;
        const WINNING_LAPS = 3;

        // Hazards and Boosts
        const oilSlicks = [{x: 150, y: 300}, {x: 750, y: 300}, {x: 450, y: 50}];
        const boostPads = [{x: 450, y: 550}];

        const players = [
            { id: 1, x: 420, y: 530, color: "#ff3d00", angle: Math.PI/2, speed: 0, laps: 0, crossed: false, spinning: 0, keys: {up:'arrowup', down:'arrowdown', left:'arrowleft', right:'arrowright'} },
            { id: 2, x: 420, y: 570, color: "#ffea00", angle: Math.PI/2, speed: 0, laps: 0, crossed: false, spinning: 0, keys: {up:'w', down:'s', left:'a', right:'d'} }
        ];

        const activeKeys = {};
        window.onkeydown = (e) => {
            activeKeys[e.key.toLowerCase()] = true;
            if(e.key === 'r' && gameOver) location.reload();
        };
        window.onkeyup = (e) => activeKeys[e.key.toLowerCase()] = false;

        function drawWorld() {
            // Track Asphalt
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 130;
            ctx.beginPath();
            ctx.ellipse(450, 300, 350, 230, 0, 0, Math.PI * 2);
            ctx.stroke();

            // Oil Slicks
            oilSlicks.forEach(s => {
                ctx.fillStyle = "rgba(0,0,0,0.8)";
                ctx.beginPath();
                ctx.arc(s.x, s.y, 25, 0, Math.PI*2);
                ctx.fill();
            });

            // Boost Pads
            boostPads.forEach(b => {
                ctx.fillStyle = "#00e5ff";
                ctx.fillRect(b.x-30, b.y-10, 60, 20);
            });

            // Finish Line
            ctx.fillStyle = "white";
            for(let i=0; i<6; i++) {
                ctx.fillRect(445, 470 + (i*20), 10, 10);
                ctx.fillStyle = (ctx.fillStyle === "#ffffff" ? "#000000" : "#ffffff");
            }
        }

        function update() {
            if (gameOver) return;

            players.forEach(p => {
                // Spinning Logic
                if (p.spinning > 0) {
                    p.angle += 0.2;
                    p.spinning--;
                    p.speed *= 0.98;
                } else {
                    if (activeKeys[p.keys.up]) p.speed += 0.25;
                    if (activeKeys[p.keys.down]) p.speed -= 0.15;
                    
                    const turnDir = p.speed >= 0 ? 1 : -1;
                    if (activeKeys[p.keys.left]) p.angle -= 0.07 * turnDir;
                    if (activeKeys[p.keys.right]) p.angle += 0.07 * turnDir;
                }

                // Check Hazards
                oilSlicks.forEach(s => {
                    if(Math.hypot(p.x - s.x, p.y - s.y) < 30) p.spinning = 40;
                });

                // Check Boosts
                boostPads.forEach(b => {
                    if(Math.hypot(p.x - b.x, p.y - b.y) < 30) p.speed = 12;
                });

                // Friction & Off-road
                const dx = p.x - 450, dy = p.y - 300;
                const dist = Math.sqrt((dx*dx)/Math.pow(350, 2) + (dy*dy)/Math.pow(230, 2));
                const onTrack = dist > 0.8 && dist < 1.2;
                
                p.speed *= onTrack ? 0.97 : 0.85;
                if (p.speed > (onTrack ? 8 : 2)) p.speed = onTrack ? 8 : 2;

                p.x += Math.sin(p.angle) * p.speed;
                p.y -= Math.cos(p.angle) * p.speed;

                // Lap Logic
                if (p.x > 440 && p.x < 460 && p.y > 470) {
                    if (!p.crossed) {
                        p.laps++; p.crossed = true;
                        document.getElementById(`p${p.id}Laps`).innerText = p.laps;
                        if (p.laps >= WINNING_LAPS) endGame(p.id);
                    }
                } else if (p.x < 400) { p.crossed = false; }
            });
        }

        function endGame(id) {
            gameOver = true;
            document.getElementById('winOverlay').style.display = "block";
            document.getElementById('winnerText').innerText = `PLAYER ${id} DOMINATES!`;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawWorld();

            players.forEach(p => {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.angle);
                
                // Detailed Car Shape
                ctx.fillStyle = "black";
                ctx.fillRect(-14, -18, 5, 10); // Tires
                ctx.fillRect(9, -18, 5, 10);
                ctx.fillRect(-14, 8, 5, 10);
                ctx.fillRect(9, 8, 5, 10);

                ctx.fillStyle = p.color;
                ctx.fillRect(-10, -20, 20, 40); // Body
                ctx.fillStyle = "cyan";
                ctx.fillRect(-8, -12, 16, 8); // Windshield
                
                ctx.restore();
            });

            update();
            requestAnimationFrame(draw);
        }

        draw();
    </script>
</body>
</html>

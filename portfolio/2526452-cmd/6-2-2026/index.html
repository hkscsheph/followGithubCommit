<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ­»å¯‚èŠå¤©å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Creepster&family=Metal+Mania&family=Special+Elite&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- å…¨å±€è¨­å®šï¼šé»‘æš—èˆ‡è¡€è‰² --- */
      body {
        background-color: #050505;
        color: #b30000; /* æš—ç´…è‰²æ–‡å­— */
        font-family: 'Special Elite', cursive; /* æ‰“å­—æ©Ÿé¢¨æ ¼ */
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-image: radial-gradient(circle, transparent 20%, #000 90%),
          repeating-linear-gradient(
            0deg,
            transparent,
            transparent 1px,
            #111 1px,
            #111 2px
          );
        background-size: cover;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* æ¨™é¡Œç‰¹æ•ˆ */
      h2 {
        font-family: 'Creepster', system-ui;
        text-align: center;
        font-size: 3em;
        color: #ff0000;
        text-shadow: 0 0 10px #ff0000, 4px 4px 0px #330000;
        animation: flicker 3s infinite;
        margin-bottom: 5px;
      }

      /* ç‹€æ…‹åˆ— */
      #status-bar {
        text-align: center;
        color: #555;
        font-family: 'Metal Mania', cursive;
        margin-bottom: 20px;
        letter-spacing: 2px;
      }

      /* --- èŠå¤©è¦–çª—ï¼šèˆŠè¢å¹•é¢¨æ ¼ --- */
      #chat-window {
        border: 2px solid #550000;
        background: rgba(10, 0, 0, 0.8);
        height: 500px;
        overflow-y: scroll;
        padding: 20px;
        box-shadow: 0 0 20px rgba(139, 0, 0, 0.3) inset;
        position: relative;
        scrollbar-width: thin;
        scrollbar-color: #500 #111;
      }

      /* æ²è»¸ç¾åŒ– */
      #chat-window::-webkit-scrollbar {
        width: 10px;
      }
      #chat-window::-webkit-scrollbar-track {
        background: #111;
      }
      #chat-window::-webkit-scrollbar-thumb {
        background: #600;
        border-radius: 5px;
      }

      /* --- è¨Šæ¯æ°£æ³¡ï¼šæ’•è£‚æ„Ÿ --- */
      .message {
        margin-bottom: 20px;
        padding: 15px;
        border-left: 4px solid #800;
        background: linear-gradient(
          90deg,
          rgba(50, 0, 0, 0.4) 0%,
          transparent 100%
        );
        position: relative;
        animation: slideIn 0.3s ease-out;
      }

      .message strong {
        color: #ff4444;
        font-size: 1.2em;
        font-family: 'Metal Mania', cursive;
        letter-spacing: 1px;
      }

      .time {
        font-size: 0.7em;
        color: #444;
        float: right;
      }

      .message div {
        margin-top: 5px;
        color: #ccc;
        text-shadow: 1px 1px 2px #000;
      }

      /* --- å¤šåª’é«”ç‰¹æ•ˆï¼šå°‹ç²éŒ„å½±å¸¶é¢¨æ ¼ --- */
      video {
        width: 100%;
        border: 1px solid #333;
        /* è®“å½±ç‰‡çœ‹èµ·ä¾†åƒèˆŠéŒ„å½±å¸¶ */
        filter: sepia(0.5) contrast(1.2) hue-rotate(-20deg) grayscale(0.3);
        margin-top: 10px;
      }
      audio {
        width: 100%;
        filter: invert(1); /* åè½‰é¡è‰²è®“æ’­æ”¾å™¨è®Šé»‘ */
        margin-top: 10px;
      }

      /* --- æ§åˆ¶å€ï¼šå„€å¼ç¥­å£‡ --- */
      .controls {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        border-top: 1px solid #333;
        padding-top: 20px;
      }

      input[type='text'] {
        background: #000;
        border: 1px solid #500;
        color: #fff;
        padding: 12px;
        font-family: 'Special Elite', cursive;
        outline: none;
      }
      input[type='text']:focus {
        border-color: #f00;
        box-shadow: 0 0 10px #500;
      }

      #username {
        width: 20%;
      }
      #message-input {
        flex-grow: 1;
      }

      /* --- æŒ‰éˆ•ï¼šç¬¦å’’é¢¨æ ¼ --- */
      button {
        background-color: #220000;
        color: #a00;
        border: 1px solid #600;
        padding: 10px 20px;
        cursor: pointer;
        font-family: 'Special Elite', cursive;
        font-weight: bold;
        transition: all 0.2s;
        text-transform: uppercase;
      }

      button:hover {
        background-color: #500;
        color: #fff;
        box-shadow: 0 0 15px #f00;
        text-shadow: 0 0 5px #fff;
      }

      /* éŒ„éŸ³ä¸­ç‰¹æ•ˆï¼šè„ˆå‹•çš„å¿ƒè‡Ÿ */
      #record-btn.recording {
        background-color: #800;
        color: #fff;
        border-color: #f00;
        animation: heartbeat 1s infinite;
      }

      /* --- å‹•ç•«å®šç¾© --- */
      @keyframes flicker {
        0%,
        19%,
        21%,
        23%,
        25%,
        54%,
        56%,
        100% {
          opacity: 1;
          text-shadow: 0 0 10px #ff0000;
        }
        20%,
        24%,
        55% {
          opacity: 0.5;
          text-shadow: none;
        }
      }

      @keyframes heartbeat {
        0% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
        }
        70% {
          transform: scale(1.1);
          box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* CRT æƒæç·šè¦†è“‹å±¤ */
      .crt-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            rgba(18, 16, 16, 0) 50%,
            rgba(0, 0, 0, 0.25) 50%
          ),
          linear-gradient(
            90deg,
            rgba(255, 0, 0, 0.06),
            rgba(0, 255, 0, 0.02),
            rgba(0, 0, 255, 0.06)
          );
        background-size: 100% 2px, 3px 100%;
        pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        z-index: 999;
      }

      #video-input {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="crt-overlay"></div>

    <h2>â€  æ­»å¯‚èŠå¤©å®¤ â€ </h2>
    <div id="status-bar">...é€£çµéˆç•Œä¸­...</div>

    <div id="chat-window"></div>

    <div class="controls">
      <input type="text" id="username" placeholder="ä»£è™Ÿ" value="ç”Ÿå­˜è€…" />
      <input
        type="text"
        id="message-input"
        placeholder="ç•™ä¸‹æœ€å¾Œéºè¨€..."
        autocomplete="off"
      />

      <button id="send-btn" onclick="sendText()">âš°ï¸ ç»ç¥­</button>
      <button id="record-btn" onclick="toggleRecording()">ğŸ‘» æ‹›é­‚(éŒ„éŸ³)</button>
      <button
        id="video-btn"
        onclick="document.getElementById('video-input').click()"
      >
        ğŸ“¼ è©›å’’éŒ„å½±å¸¶
      </button>
      <input
        type="file"
        id="video-input"
        accept="video/*"
        onchange="handleVideoUpload(this)"
      />
    </div>

    <script>
      // Supabase è¨­å®š (ä¿æŒä¸è®Š)
      const SUPABASE_URL = 'https://gzojagtmyrptkrpirxqy.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_A3LiEJYlX0zBPcIQ0Drw-Q_0oOepQg1';
      const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      const chatWindow = document.getElementById('chat-window');
      const statusBar = document.getElementById('status-bar');

      let mediaRecorder;
      let audioChunks = [];
      let isRecording = false;

      // --- æ ¸å¿ƒé‚è¼¯ (èˆ‡ä¹‹å‰å®Œå…¨ç›¸åŒï¼Œåªæ”¹äº†æç¤ºæ–‡å­—) ---

      async function saveMessageToDB(content, type) {
        const username =
          document.getElementById('username').value || 'ä¸æ˜ç‰©é«”';
        const { error } = await _supabase
          .from('messages')
          .insert([{ content: content, username: username, msg_type: type }]);

        if (error) {
          console.error(error);
          statusBar.innerText = 'â˜ ï¸ å„€å¼å¤±æ•—...';
          statusBar.style.color = 'red';
        }
      }

      function sendText() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text) return;
        saveMessageToDB(text, 'text');
        input.value = '';
      }

      async function toggleRecording() {
        const btn = document.getElementById('record-btn');
        if (!isRecording) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = (event) =>
              audioChunks.push(event.data);
            mediaRecorder.onstop = async () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
              await uploadFileAndSend(audioBlob, 'audio', 'haunted_voice.webm');
            };
            mediaRecorder.start();
            isRecording = true;
            btn.classList.add('recording');
            btn.innerText = 'ğŸ©¸ åœæ­¢å„€å¼';
            statusBar.innerText = 'éˆé«”éŒ„è£½ä¸­...';
          } catch (err) {
            alert('éº¥å…‹é¢¨è¢«éˆé«”å¹²æ“¾: ' + err);
          }
        } else {
          mediaRecorder.stop();
          isRecording = false;
          btn.classList.remove('recording');
          btn.innerText = 'ğŸ‘» æ‹›é­‚(éŒ„éŸ³)';
          mediaRecorder.stream.getTracks().forEach((track) => track.stop());
        }
      }

      async function handleVideoUpload(input) {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 50 * 1024 * 1024) {
          alert('æª”æ¡ˆå¤ªå¤§ï¼Œæ€¨å¿µå¤ªé‡');
          return;
        }
        await uploadFileAndSend(file, 'video', file.name);
        input.value = '';
      }

      async function uploadFileAndSend(fileBody, msgType, fileName) {
        statusBar.innerText = `æ­£åœ¨ä¸Šå‚³è©›å’’åª’ä»‹ ${msgType}...`;
        const uniqueName = `${Date.now()}_${Math.random()
          .toString(36)
          .substr(2, 9)}_${fileName}`;
        const filePath = `${msgType}s/${uniqueName}`;

        const { error } = await _supabase.storage
          .from('chat_images')
          .upload(filePath, fileBody);
        if (error) {
          console.error(error);
          statusBar.innerText = 'ä¸Šå‚³è¢«å°å°';
          return;
        }

        const { data: urlData } = _supabase.storage
          .from('chat_images')
          .getPublicUrl(filePath);
        await saveMessageToDB(urlData.publicUrl, msgType);
        statusBar.innerText = 'è©›å’’å·²ç™¼é€';
        setTimeout(() => (statusBar.innerText = '...é€£çµéˆç•Œä¸­...'), 2000);
      }

      function appendMessage(msg) {
        const div = document.createElement('div');
        div.className = 'message';

        // è®“æ™‚é–“çœ‹èµ·ä¾†æ¯”è¼ƒè©­ç•°
        const time = new Date(msg.created_at).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit',
        });
        const safeUser = escapeHtml(msg.username);

        let contentHtml = '';
        if (msg.msg_type === 'audio') {
          contentHtml = `<audio controls src="${msg.content}"></audio>`;
        } else if (msg.msg_type === 'video') {
          contentHtml = `<video controls src="${msg.content}"></video>`;
        } else {
          contentHtml = `<div>${escapeHtml(msg.content)}</div>`;
        }

        div.innerHTML = `<strong>${safeUser}</strong><span class="time">${time}</span>${contentHtml}`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      async function init() {
        const { data } = await _supabase
          .from('messages')
          .select('*')
          .order('created_at', { ascending: true })
          .limit(50);
        if (data) data.forEach(appendMessage);

        _supabase
          .channel('room1')
          .on(
            'postgres_changes',
            { event: 'INSERT', schema: 'public', table: 'messages' },
            (payload) => {
              appendMessage(payload.new);
              // æ”¶åˆ°æ–°è¨Šæ¯æ™‚çš„é¡å¤–ææ€–ç‰¹æ•ˆ (é¸ç”¨)
              document.body.style.textShadow = '2px 0 0 red, -2px 0 0 blue';
              setTimeout(() => (document.body.style.textShadow = 'none'), 200);
            }
          )
          .subscribe();
      }

      function escapeHtml(text) {
        if (!text) return '';
        return text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      init();
    </script>
  </body>
</html>

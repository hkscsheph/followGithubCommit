<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­è«‹å‡è‡ªå‹•ç”Ÿæˆç³»çµ± V2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --whatsapp: #25D366;
            --bg: #ecf0f1;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: var(--primary); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn { padding: 10px 20px; border: none; background: #ddd; cursor: pointer; border-radius: 20px; font-weight: bold; }
        .tab-btn.active { background: var(--accent); color: white; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        /* ç°½åæ¿æ¨£å¼ */
        .signature-wrapper { border: 2px dashed #ccc; border-radius: 8px; position: relative; height: 150px; background: #fffcf5; }
        canvas { width: 100%; height: 100%; }
        .clear-sig { position: absolute; top: 5px; right: 5px; background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-gen { background: var(--primary); }
        .btn-pdf { background: #e74c3c; display: none; } /* åˆå§‹éš±è— */
        .btn-copy { background: #f39c12; display: none; }
        .btn-wa { background: var(--whatsapp); display: none; }

        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        /* é è¦½å€åŸŸ - æ¨¡æ“¬ A4 ç´™å¼µ */
        #previewSection { 
            display: none; 
            margin-top: 30px; 
            background: #fff; 
            padding: 40px; 
            border: 1px solid #ddd; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* åˆ—å°/PDF å°ˆç”¨æ¨£å¼ */
        .official-doc { font-family: 'Times New Roman', serif; line-height: 1.8; color: #000; }
        .doc-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .doc-title { font-size: 24px; font-weight: bold; letter-spacing: 2px; }
        .doc-body { margin-bottom: 40px; white-space: pre-wrap; }
        .doc-footer { display: flex; justify-content: space-between; margin-top: 50px; }
        .sign-area { text-align: center; }
        .sign-img { max-height: 60px; display: block; margin: 0 auto; }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .btn-group { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“„ æ™ºæ…§è«‹å‡ç³»çµ± V2.0</h1>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="setMode('formal')">æ­£å¼å…¬æ–‡æ¨¡å¼</button>
        <button class="tab-btn" onclick="setMode('chat')">é€šè¨Šè»Ÿé«”æ¨¡å¼</button>
    </div>

    <form id="mainForm">
        <div class="form-grid">
            <div>
                <label>ç”³è«‹äººå§“å</label>
                <input type="text" id="name" placeholder="ç‹å°æ˜">
            </div>
            <div>
                <label>æ‰€å±¬éƒ¨é–€</label>
                <input type="text" id="dept" placeholder="æ¥­å‹™éƒ¨">
            </div>
            
            <div>
                <label>é–‹å§‹æ—¥æœŸ</label>
                <input type="date" id="startDate">
            </div>
            <div>
                <label>çµæŸæ—¥æœŸ</label>
                <input type="date" id="endDate">
            </div>

            <div class="full-width">
                <label>è«‹å‡é¡åˆ¥</label>
                <select id="type">
                    <option value="sick">ç—…å‡ (éœ€ä¼‘é¤Š)</option>
                    <option value="personal">äº‹å‡ (ç§äººäº‹å‹™)</option>
                    <option value="annual">ç‰¹ä¼‘/å¹´å‡ (æ”¾é¬†å……é›»)</option>
                    <option value="wfh">å±…å®¶è¾¦å…¬ç”³è«‹ (WFH)</option>
                </select>
            </div>

            <div class="full-width">
                <label>è«‹å‡åŸå›  (è¼¸å…¥é—œéµå­—ï¼ŒAI è‡ªå‹•æ“´å¯«)</label>
                <textarea id="reason" rows="3" placeholder="ä¾‹å¦‚ï¼šåƒå£è‚šå­ã€è¦å»éŠ€è¡Œè¾¦äº‹ã€å°å­©å­¸æ ¡æœ‰æ´»å‹•..."></textarea>
            </div>

            <div class="full-width" id="sigContainer">
                <label>æ‰‹å¯«ç°½å (è«‹åœ¨ä¸‹æ–¹æ–¹æ¡†å…§ç°½å)</label>
                <div class="signature-wrapper">
                    <canvas id="signature-pad"></canvas>
                    <button type="button" class="clear-sig" onclick="clearSignature()">æ¸…é™¤é‡ç°½</button>
                </div>
            </div>
        </div>

        <div class="btn-group">
            <div class="btn-group">
                <button type="button" class="btn btn-gen" ...> ... </button>
                <button type="button" class="btn btn-email" onclick="openEmailDraft()">ğŸ“§ é–‹å•Ÿ Email</button>
                <button type="button" class="btn btn-cal" onclick="addToCalendar()">ğŸ“… åŠ å…¥è¡Œäº‹æ›†</button>
                </div>   
            <button type="button" class="btn btn-gen" onclick="generateDocument()">âš¡ ç”Ÿæˆé è¦½</button>
            <button type="button" class="btn btn-pdf" id="btnPdf" onclick="downloadPDF()">ğŸ“¥ ä¸‹è¼‰ PDF</button>
            <button type="button" class="btn btn-copy" id="btnCopy" onclick="copyText()">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
            <button type="button" class="btn btn-wa" id="btnWa" onclick="shareToWhatsApp()">ğŸ’¬ å‚³é€ WhatsApp</button>
        </div>
    </form>

    <div id="previewSection">
        <div class="official-doc" id="docContent">
            <div class="doc-header">
                <div class="doc-title">è«‹ å‡ ç”³ è«‹ å–®</div>
                <div style="font-size: 14px; margin-top:5px;">Leave Application Form</div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong>è‡´ ä¸»ç®¡/äººè³‡éƒ¨ï¼š</strong>
            </div>

            <div class="doc-body" id="finalBody">
                </div>

            <div class="doc-footer">
                <div>
                    <p>å¯©æ ¸ä¸»ç®¡ï¼š_________________</p>
                </div>
                <div class="sign-area">
                    <p>ç”³è«‹äººç°½åï¼š</p>
                    <img id="finalSig" class="sign-img" alt="ç°½å" />
                    <p id="finalDate" style="font-size: 12px; margin-top: 5px;"></p>
                </div>
            </div>
        </div>
        <div style="margin-top:20px; font-size:10px; color:#999; text-align:center; border-top:1px solid #eee; padding-top:5px;">
            æœ¬æ–‡ä»¶ç”±è‡ªå‹•åŒ–ç³»çµ±ç”Ÿæˆï¼Œå…§å®¹ä¹‹çœŸå¯¦æ€§ç”±ç”³è«‹äººè² è²¬ã€‚
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–ç°½åæ¿
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);

    // è™•ç†è¦–çª—å¤§å°æ”¹è®Šæ™‚ canvas çš„èª¿æ•´
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear(); // èª¿æ•´å¤§å°éœ€æ¸…é™¤ï¼Œå¦å‰‡åº§æ¨™æœƒè·‘æ‰
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function clearSignature() {
        signaturePad.clear();
    }

    let currentMode = 'formal';

    function setMode(mode) {
        currentMode = mode;
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        if (mode === 'chat') {
            document.getElementById('sigContainer').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
        } else {
            document.getElementById('sigContainer').style.display = 'block';
        }
        
        // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
        document.getElementById('btnPdf').style.display = 'none';
        document.getElementById('btnCopy').style.display = 'none';
        document.getElementById('btnWa').style.display = 'none';
    }

    function generateDocument() {
        const name = document.getElementById('name').value;
        const dept = document.getElementById('dept').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const type = document.getElementById('type').value;
        const rawReason = document.getElementById('reason').value;

        if(!name || !start || !end) {
            alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            return;
        }

        // ç°¡å–®è¦å‰‡é‚è¼¯ (æ¨¡æ“¬ AI æ½¤é£¾)
        let polishedReason = "";
        let subject = "";

        if (type === 'sick') {
            subject = "ç—…å‡ç”³è«‹";
            polishedReason = rawReason 
                ? `æœ¬äººå› ${rawReason}ï¼Œèº«é«”ä¸é©ã€‚ç¶“è©•ä¼°å¾Œå»ºè­°åœ¨å®¶ä¼‘é¤Šï¼Œä»¥é¿å…ç—…æƒ…åŠ é‡æˆ–å½±éŸ¿åŒäº‹å¥åº·ã€‚`
                : "æœ¬äººå› çªç™¼æ€§èº«é«”ä¸é©ï¼Œéœ€è«‹ç—…å‡åœ¨å®¶ä¼‘é¤Šã€‚";
        } else if (type === 'personal') {
            subject = "äº‹å‡ç”³è«‹";
            polishedReason = rawReason 
                ? `æœ¬äººå› ${rawReason}ï¼Œå±¬å¿…è¦ä¹‹ç§äººäº‹å‹™ï¼Œéœ€è¦ªè‡ªè™•ç†ï¼Œæ•…ç„¡æ³•æ–¼ç•¶æ—¥å‡ºå‹¤ã€‚`
                : "æœ¬äººå› æœ‰é‡è¦ç§äººè¡Œç¨‹éœ€è™•ç†ï¼Œæ“¬è«‹äº‹å‡ã€‚";
        } else if (type === 'wfh') {
            subject = "å±…å®¶è¾¦å…¬(WFH)ç”³è«‹";
            polishedReason = `æœ¬äººå› ${rawReason || "å€‹äººè¡Œç¨‹å®‰æ’"}ï¼Œæ“¬ç”³è«‹å±…å®¶è¾¦å…¬ã€‚æœŸé–“å°‡ä¿æŒç¶²è·¯é€šæš¢ï¼Œä¸å½±éŸ¿å…¬å‹™è¯ç¹«èˆ‡å°ˆæ¡ˆé€²åº¦ã€‚`;
        } else {
            subject = "ç‰¹ä¼‘ç”³è«‹";
            polishedReason = "ç‚ºèª¿ç¯€èº«å¿ƒå¹³è¡¡ï¼Œæ“¬ç”³è«‹å¹´åº¦ç‰¹åˆ¥ä¼‘å‡ã€‚";
        }

        const dateRange = start === end ? `${start} (1å¤©)` : `${start} è‡³ ${end}`;

        if (currentMode === 'formal') {
            // æ­£å¼æ¨¡å¼ï¼šç”Ÿæˆ HTML é è¦½
            const bodyHtml = `
                <p><strong>ç”³è«‹äººï¼š</strong> ${name} (${dept})</p>
                <p><strong>è«‹å‡æœŸé–“ï¼š</strong> ${dateRange}</p>
                <p><strong>å‡åˆ¥ï¼š</strong> ${subject}</p>
                <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">
                <p><strong>äº‹ç”±èªªæ˜ï¼š</strong></p>
                <p>${polishedReason}</p>
                <p>ä¼‘å‡æœŸé–“è‹¥æœ‰ç·Šæ€¥å…¬å‹™ï¼Œè«‹ä»¥ Email æˆ–é›»è©±è¯ç¹«ã€‚æ‡‡è«‹ æ‰¹å‡†ã€‚</p>
            `;
            
            document.getElementById('finalBody').innerHTML = bodyHtml;
            document.getElementById('finalDate').innerText = "æ—¥æœŸï¼š" + new Date().toISOString().slice(0,10);

            // è™•ç†ç°½å
            if (!signaturePad.isEmpty()) {
                document.getElementById('finalSig').src = signaturePad.toDataURL();
                document.getElementById('finalSig').style.display = 'block';
            } else {
                document.getElementById('finalSig').style.display = 'none';
            }

            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('btnPdf').style.display = 'block'; // é¡¯ç¤º PDF æŒ‰éˆ•
            
            // æ»¾å‹•åˆ°é è¦½
            document.getElementById('previewSection').scrollIntoView({behavior: "smooth"});

        } else {
            // èŠå¤©æ¨¡å¼ï¼šç”Ÿæˆæ–‡å­—
            const chatText = `ã€${subject}ã€‘\nä¸»ç®¡æ‚¨å¥½ï¼Œæˆ‘æ˜¯${dept}çš„${name}ã€‚\n\n${polishedReason}\n\næ—¥æœŸï¼š${dateRange}\n\néº»ç…©æ‚¨äº†ï¼Œè¬è¬ï¼`;
            
            // å­˜å„²å…¨åŸŸè®Šæ•¸ä¾›æŒ‰éˆ•ä½¿ç”¨
            window.generatedChatText = chatText;
            
            document.getElementById('btnCopy').style.display = 'block';
            document.getElementById('btnWa').style.display = 'block';
            alert("çŸ­è¨Šæ¯å…§å®¹å·²ç”Ÿæˆï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½æˆ–å‚³é€ï¼");
        }
    }

    function downloadPDF() {
        const element = document.getElementById('previewSection');
        const opt = {
            margin:       10,
            filename:     `è«‹å‡å–®_${document.getElementById('name').value}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function copyText() {
        navigator.clipboard.writeText(window.generatedChatText);
        alert("æ–‡å­—å·²è¤‡è£½ï¼");
    }

    function shareToWhatsApp() {
        const text = encodeURIComponent(window.generatedChatText);
        window.open(`https://wa.me/?text=${text}`, '_blank');
    }
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GitHub Commit å¯¦æ™‚è¿½è¹¤å™¨</title>
    <style>
      :root {
        --bg-color: #0d1117;
        --card-bg: #161b22;
        --text-main: #c9d1d9;
        --text-secondary: #8b949e;
        --accent: #58a6ff;
        --border: #30363d;
        --success: #238636;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
        gap: 10px;
      }

      h1 {
        margin: 0;
        font-size: 1.5rem;
      }

      .controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      input[type='password'] {
        background: var(--bg-color);
        border: 1px solid var(--border);
        color: var(--text-main);
        padding: 8px;
        border-radius: 6px;
        width: 200px;
      }

      button {
        background-color: var(--success);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
      }

      button:hover {
        background-color: #2ea043;
      }
      button:disabled {
        background-color: var(--border);
        cursor: not-allowed;
      }

      .status-bar {
        margin-bottom: 15px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      /* Grid Layout */
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
      }

      /* User Card */
      .card {
        background-color: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 15px;
        transition: transform 0.2s;
        position: relative;
      }

      .card:hover {
        border-color: var(--text-secondary);
      }

      .user-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        background-color: var(--border);
      }

      .username {
        font-weight: bold;
        color: var(--accent);
        text-decoration: none;
      }

      .username:hover {
        text-decoration: underline;
      }

      .last-active {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-left: auto;
      }

      .commit-info {
        font-size: 0.9rem;
        border-top: 1px solid var(--border);
        padding-top: 10px;
        margin-top: 10px;
      }

      .repo-name {
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin-bottom: 5px;
      }

      .commit-msg {
        background: rgba(110, 118, 129, 0.1);
        padding: 8px;
        border-radius: 4px;
        font-family: monospace;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .badge {
        display: inline-block;
        padding: 2px 6px;
        font-size: 0.7rem;
        border-radius: 10px;
        margin-left: 5px;
      }
      .badge-push {
        background-color: #238636;
        color: white;
      }
      .badge-none {
        background-color: var(--border);
        color: var(--text-secondary);
      }
      .badge-error {
        background-color: #da3633;
        color: white;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>GitHub Commit è¿½è¹¤å„€è¡¨æ¿</h1>
        <div class="controls">
          <input
            type="password"
            id="apiToken"
            placeholder="GitHub Token (é¸å¡«ï¼Œé¿å…è¢«é–)"
          />
          <button id="refreshBtn" onclick="fetchAllData()">ç«‹å³åˆ·æ–°</button>
        </div>
      </header>

      <div class="status-bar" id="statusBar">
        æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šåˆ·æ–°æˆ–ç­‰å¾…è‡ªå‹•æ›´æ–°...
      </div>

      <div id="userGrid" class="grid"></div>
    </div>

    <script>
      // ç›£æ§ç›®æ¨™åå–®
      const targetUsers = [
        'hkscsheph',
        '2223107-cami',
        'Koodybiglookyea',
        'haha197',
        'kory520',
        'kou1gn',
        'BARON1118',
        'v1ann',
        'EmilyLau41',
        '2526431-Michael',
        'giovanniuufj',
        '2526452-cmd',
        '2526453',
        '2526454-ship-it',
        'hayden626',
        'ethanhksc0930',
        '2526465-lgtm',
        '2223176-tech',
        '2526470-collab',
        'crazyjayhm'
      ];

      const grid = document.getElementById('userGrid');
      const statusBar = document.getElementById('statusBar');
      const refreshBtn = document.getElementById('refreshBtn');
      const apiTokenInput = document.getElementById('apiToken');

      // Load token from backend on page load
      async function loadTokenFromEnv() {
        try {
          const response = await fetch('/api/token');
          const data = await response.json();
          if (data.token) {
            apiTokenInput.value = data.token;
            statusBar.innerText = 'âœ“ Token å·²å¾ .env è‡ªå‹•è¼‰å…¥';
            return true;
          }
        } catch (err) {
          console.log('ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥ Tokenï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
        }
        return false;
      }

      // åˆå§‹åŒ–å¡ç‰‡
      function initCards() {
        grid.innerHTML = '';
        targetUsers.forEach((user) => {
          const card = document.createElement('div');
          card.className = 'card';
          card.id = `card-${user}`;
          card.innerHTML = `
                <div class="user-header">
                    <div class="avatar"></div>
                    <div>
                        <a href="repos.html?user=${user}" class="username">${user}</a>
                        <span class="badge badge-none" id="badge-${user}">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
                <div class="commit-info" id="info-${user}">
                    <div class="repo-name">è®€å–ä¸­...</div>
                </div>
            `;
          grid.appendChild(card);
        });
      }

      async function fetchUserEvents(username, token) {
        const headers = token ? { Authorization: `token ${token}` } : {};
        try {
          const response = await fetch(
            `https://api.github.com/users/${username}/events/public?per_page=30`,
            { headers }
          );

          if (response.status === 404)
            return { user: username, error: 'ç”¨æˆ¶ä¸å­˜åœ¨' };
          if (response.status === 403)
            return { user: username, error: 'API é™åˆ¶ (è«‹å¡«å…¥ Token)' };
          if (!response.ok) return { user: username, error: 'æœªçŸ¥éŒ¯èª¤' };

          const events = await response.json();
          
          // Collect all push events
          const pushEvents = events.filter((e) => e.type === 'PushEvent');
          
          // Fetch all commits from push events in parallel
          const commitPromises = [];
          for (const pushEvent of pushEvents) {
            const repoName = pushEvent.repo.name;
            const head = pushEvent.payload.head;
            const before = pushEvent.payload.before;
            
            // Use compare endpoint to get all commits in this push
            commitPromises.push(
              fetch(
                `https://api.github.com/repos/${repoName}/compare/${before}...${head}`,
                { headers }
              )
              .then(r => r.ok ? r.json() : null)
              .catch(() => null)
              .then(data => {
                if (data && data.commits && Array.isArray(data.commits)) {
                  return data.commits.map(commit => ({
                    message: commit.commit.message,
                    repo: repoName,
                    sha: commit.sha,
                    date: commit.commit.author.date,
                    url: commit.html_url
                  }));
                }
                return [];
              })
            );
          }

          const allCommitArrays = await Promise.all(commitPromises);
          let commits = allCommitArrays.flat()
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);

          // If we don't have enough commits, fetch from repos
          if (commits.length < 5) {
            try {
              const reposResponse = await fetch(
                `https://api.github.com/users/${username}/repos?sort=updated&per_page=5`,
                { headers }
              );
              if (reposResponse.ok) {
                const repos = await reposResponse.json();
                const repoNames = new Set(commits.map(c => c.repo));
                
                const repoCommitPromises = repos
                  .filter(r => !repoNames.has(r.full_name))
                  .slice(0, 5 - commits.length)
                  .map(repo =>
                    fetch(
                      `https://api.github.com/repos/${repo.full_name}/commits?per_page=1`,
                      { headers }
                    )
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null)
                    .then(data => {
                      if (data && data.length > 0) {
                        const commit = data[0];
                        return {
                          message: commit.commit.message,
                          repo: repo.full_name,
                          sha: commit.sha,
                          date: commit.commit.author.date,
                          url: commit.html_url
                        };
                      }
                      return null;
                    })
                  );
                
                const repoCommits = (await Promise.all(repoCommitPromises)).filter(c => c);
                commits = commits.concat(repoCommits).slice(0, 5);
              }
            } catch (err) {
              console.log(`Failed to fetch repos for ${username}`);
            }
          }

          return {
            user: username,
            commits: commits,
            lastActive: events.length > 0 ? events[0].created_at : null,
            avatar: events.length > 0 ? events[0].actor.avatar_url : null,
            hasActivity: commits.length > 0
          };
        } catch (err) {
          return { user: username, error: 'ç¶²çµ¡éŒ¯èª¤' };
        }
      }

      async function fetchAllData() {
        const token = document.getElementById('apiToken').value.trim();
        refreshBtn.disabled = true;
        refreshBtn.innerText = 'æ›´æ–°ä¸­...';
        statusBar.innerText = `æ­£åœ¨æŠ“å– ${targetUsers.length} ä½ç”¨æˆ¶çš„è³‡æ–™...`;

        const promises = targetUsers.map((user) =>
          fetchUserEvents(user, token)
        );
        const results = await Promise.all(promises);

        // æ ¹æ“šæœ€å¾Œæ´»å‹•æ™‚é–“æ’åº (æœ€æ–°çš„åœ¨å‰é¢)
        results.sort((a, b) => {
          const dateA = a.data
            ? new Date(a.data.created_at)
            : a.lastActive
            ? new Date(a.lastActive)
            : new Date(0);
          const dateB = b.data
            ? new Date(b.data.created_at)
            : b.lastActive
            ? new Date(b.lastActive)
            : new Date(0);
          return dateB - dateA;
        });

        updateUI(results);

        refreshBtn.disabled = false;
        refreshBtn.innerText = 'ç«‹å³åˆ·æ–°';
        statusBar.innerText = `æ›´æ–°å®Œæˆæ–¼ ${new Date().toLocaleTimeString()}`;
      }

      function timeAgo(dateString) {
        if (!dateString) return 'å¾ˆä¹…ä»¥å‰';
        const date = new Date(dateString);
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;

        if (interval > 1) return Math.floor(interval) + ' å¹´å‰';
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + ' å€‹æœˆå‰';
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + ' å¤©å‰';
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + ' å°æ™‚å‰';
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + ' åˆ†é˜å‰';
        return 'å‰›å‰›';
      }

      function updateUI(results) {
        // å› ç‚ºæ’åºéäº†ï¼Œæˆ‘å€‘ä½¿ç”¨ Flex order æˆ–é‡æ–°æ’å…¥ DOM ä¾†æ’åº
        // é€™è£¡é¸æ“‡æ¸…ç©ºä¸¦é‡æ–°æ’å…¥ï¼Œç¢ºä¿è¦–è¦ºé †åº
        grid.innerHTML = '';

        results.forEach((res) => {
          const card = document.createElement('div');
          card.className = 'card';

          let statusBadge = '';
          let contentHtml = '';
          let avatarUrl = res.avatar || 'https://github.com/github.png?size=40';

          if (res.error) {
            statusBadge = `<span class="badge badge-error">${res.error}</span>`;
            contentHtml = `<div class="repo-name" style="color:#da3633">ç„¡æ³•è®€å–è³‡æ–™</div>`;
          } else if (res.commits && res.commits.length > 0) {
            // æœ‰ Commits è³‡æ–™
            statusBadge = `<span class="badge badge-push">${res.commits.length} Commits</span>`;
            const commitsHtml = res.commits.map((commit, idx) => {
              const msg = commit.message.split('\n')[0].substring(0, 40); // åªå–ç¬¬ä¸€è¡Œï¼Œæœ€å¤š40å­—
              const time = timeAgo(commit.date);
              const repoShort = commit.repo.split('/')[1];
              return `<div style="font-size: 0.8rem; margin-bottom: 5px; display: flex; gap: 8px; align-items: center;">
                <a href="https://github.com/${commit.repo}" target="_blank" style="color: var(--accent); text-decoration: none; min-width: 50px; cursor: pointer;">${repoShort}</a>
                <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">ğŸ“ ${msg}</span>
                <span style="color: var(--text-secondary); min-width: 60px; text-align: right;">${time}</span>
              </div>`;
            }).join('');
            contentHtml = `<div style="padding-top: 8px;">${commitsHtml}</div>`;
          } else {
            // æ²’æœ‰ Commits è³‡æ–™
            statusBadge = `<span class="badge badge-none">ç„¡è¿‘æœŸæ´»å‹•</span>`;
            contentHtml = `<div class="repo-name">è¿‘æœŸç„¡ Push ç´€éŒ„</div>`;
          }

          card.innerHTML = `
                <div class="user-header">
                    <img src="${avatarUrl}" class="avatar" alt="${res.user}">
                    <div>
                        <a href="https://github.com/${res.user}" class="username">${res.user}</a>
                        ${statusBadge}
                    </div>
                </div>
                <div class="commit-info">
                    ${contentHtml}
                </div>
            `;
          grid.appendChild(card);
        });
      }

      // å•Ÿå‹•
      initCards();
      loadTokenFromEnv().then(() => {
        // è‡ªå‹•ä½¿ç”¨è¼‰å…¥çš„ Token é€²è¡Œé¦–æ¬¡æŠ“å–
        fetchAllData();
      });
    </script>
  </body>
</html>
